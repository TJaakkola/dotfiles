
# Print database configuration
function xdb { docker exec -it $1 cat /etc/xroad/db.properties }

# Start port forwarding ssh-connection to x-road environments
function xbastion { ssh -D12765 bastion.x-road.rocks }

# Get api key from ss1
function xkey { 
  docker exec -it ss1 curl -X POST -u xrd:secret https://localhost:4000/api/api-key --data '["XROAD_REGISTRATION_OFFICER","XROAD_SECURITYSERVER_OBSERVER","XROAD_SECURITY_OFFICER","XROAD_SERVICE_ADMINISTRATOR","XROAD_SYSTEM_ADMINISTRATOR"]' --header "Content-Type: application/json" -k
}

# Open database console to ss1
function xdbc {
  docker exec -it -u postgres ss1 bash -c "psql;"
}

# List log files in security server
function xloglist {
  docker exec -it ss1 ls -l /var/log/xroad
}

# Print spesific log file in security server
function xlog {
  docker exec -it ss1 cat /var/log/xroad/$1
}

# switch openapi3 description in kapsi-space
function xswitch {
  ssh etulinja@kapsi.fi 'cd sites/etulinja.kapsi.fi/www && mv example.yaml example_tmp.yaml && mv example_other.yaml example.yaml && mv example_tmp.yaml example_other.yaml'
}

# Print tail for a logfile
function xtail {
  docker exec -it ss1 tail -f /var/log/xroad/$1
} 

# Remove and recreate dev containers
function xrecreate-containers {
  cd $XROAD_UTILS_HOME/docker/dev && docker-compose down
  cd $XROAD_UTILS_HOME/docker/dev/tools && ./setup_dev_containers.sh true
}


### PROXY-UI-API

# Run tests on proxy-ui-api
function xp-test {
  docker exec -it -w /home/builder/xroad/src/proxy-ui-api builder bash -c "../gradlew test -Pskip-frontend-build"
}

# Build (without frontend)
function xp-build {
  docker exec -it -w /home/builder/xroad/src/proxy-ui-api builder bash -c "../gradlew build -Pskip-frontend-build"
}

# Configure local proxy-ui-api so that it can be run on host
function xp-host-config {
  sed -i '' 's/4100/5000/g' "$XROAD_HOME"/src/proxy-ui-api/frontend/.env.local
  sed -i '' 's/port: 4000/port: 5000/g' "$XROAD_HOME"/src/proxy-ui-api/src/main/resources/common-application.yml
  sed -i '' 's/classes.dependsOn make/\/\/classes.dependsOn make/g' "$XROAD_HOME"/src/common-util/build.gradle
  sed -i '' 's/clean.dependsOn makeClean/\/\/clean.dependsOn makeClean/g' "$XROAD_HOME"/src/common-util/build.gradle
}

# Reset local proxy-ui-api so that it is run in container
function xp-host-reset {
  sed -i '' 's/5000/4100/g' "$XROAD_HOME"/src/proxy-ui-api/frontend/.env.local
  sed -i '' 's/port: 5000/port: 4000/g' "$XROAD_HOME"/src/proxy-ui-api/src/main/resources/common-application.yml
  sed -i '' 's/\/\/classes.dependsOn make/classes.dependsOn make/g' "$XROAD_HOME"/src/common-util/build.gradle
  sed -i '' 's/\/\/clean.dependsOn makeClean/clean.dependsOn makeClean/g' "$XROAD_HOME"/src/common-util/build.gradle
}

# Setup proxy-ui-api on host
function xp-host {
  cwd="$(pwd)"
  cd $XROAD_UTILS_HOME/docker/dev && docker-compose down
  cd $XROAD_UTILS_HOME/docker/dev/tools && ./setup_proxy_api_ui_on_host.sh 
  ./reload_api_ui_backend.sh
  cd "$cwd"
}

# Run single test-file given as parameter
function xp-single-test {
  docker exec -it -w /home/builder/xroad/src/proxy-ui-api builder bash -c "../gradlew -Dtest.single=$1 -Pskip-frontend-build -xcheckstyleTest -xcheckstyleMain test"
} 

# Build and deploy proxy-ui-api backend to container
function xp-reload {
  cwd="$(pwd)" 
  cd $XROAD_UTILS_HOME/docker/dev/tools
  ./reload_api_ui_backend.sh
  cd "$cwd"
}
